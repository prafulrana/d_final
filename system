#!/bin/bash
# Full system (frpc + DeepStream + relay check)

FRPC_CONFIG="/root/d_final/.scripts/frpc/frpc.ini"
FRPC_LOG="/var/log/frpc.log"

frpc_start() {
    if pgrep -x frpc > /dev/null; then
        echo "✓ frpc already running"
        return 0
    fi
    nohup frpc -c "$FRPC_CONFIG" > "$FRPC_LOG" 2>&1 &
    sleep 3
    if pgrep -x frpc > /dev/null; then
        if grep -q "login to server success" "$FRPC_LOG" 2>/dev/null; then
            echo "✓ frpc started and connected"
            return 0
        else
            echo "✓ frpc started (waiting for connection...)"
            return 0
        fi
    else
        echo "✗ frpc failed to start"
        return 1
    fi
}

frpc_stop() {
    if pgrep -x frpc > /dev/null; then
        pkill -x frpc
        sleep 1
        echo "✓ frpc stopped"
    fi
}

case "$1" in
    start)
        NUM_STREAMS="${2:-4}"
        frpc_start && ./ds_simple start "$NUM_STREAMS"
        ;;
    stop)
        ./ds_simple stop && frpc_stop
        ;;
    restart)
        NUM_STREAMS="${2:-4}"
        $0 stop
        sleep 1
        $0 start "$NUM_STREAMS"
        ;;
    status)
        ./.scripts/check.sh
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
