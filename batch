#!/bin/bash
# Batch inference container management (Python with dynamic source add/remove)

CONTAINER_NAME="ds-batch"
IMAGE_NAME="ds-batch:latest"
API_PORT=5555

# Check if argument is a number (shortcut: ./batch N starts N streams)
if [[ "$1" =~ ^[0-9]+$ ]]; then
    NUM_STREAMS="$1"

    # Stop existing batch container
    docker stop "$CONTAINER_NAME" 2>/dev/null
    docker rm "$CONTAINER_NAME" 2>/dev/null

    echo "Starting batch inference with $NUM_STREAMS streams..."
    docker run -d --name "$CONTAINER_NAME" --gpus all --net=host \
      -v /root/d_final/batch_inference/config:/config \
      -v /root/d_final/models:/models \
      "$IMAGE_NAME"

    sleep 3
    if docker ps --filter "name=$CONTAINER_NAME" --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
        echo "✓ Batch inference container started"

        # Add N streams
        for i in $(seq 0 $((NUM_STREAMS-1))); do
            curl -s -X POST http://localhost:$API_PORT/stream/add \
              -H "Content-Type: application/json" \
              -d "{\"id\": $i}" > /dev/null
            echo "  ✓ Added stream $i"
        done

        echo ""
        echo "Active streams: 0-$((NUM_STREAMS-1))"
        echo "RTSP outputs: rtsp://localhost:8554-$((8553+NUM_STREAMS))/ds-test"
    else
        echo "✗ Failed to start batch container"
        docker logs "$CONTAINER_NAME"
    fi
    exit 0
fi

case "$1" in
    build)
        echo "Building batch inference image..."
        docker build -t "$IMAGE_NAME" -f /root/d_final/batch_inference/Dockerfile /root/d_final/batch_inference
        ;;
    start)
        NUM_STREAMS="${2:-0}"

        # Stop existing batch container
        docker stop "$CONTAINER_NAME" 2>/dev/null
        docker rm "$CONTAINER_NAME" 2>/dev/null

        echo "Starting batch inference container..."
        docker run -d --name "$CONTAINER_NAME" --gpus all --net=host \
          -v /root/d_final/batch_inference/config:/config \
          -v /root/d_final/models:/models \
          "$IMAGE_NAME"

        sleep 3
        if docker ps --filter "name=$CONTAINER_NAME" --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
            echo "✓ Batch inference container started"
            echo "  HTTP API: http://localhost:$API_PORT"
            echo "  RTSP outputs: rtsp://localhost:8554-8589/ds-test (per stream)"

            # Add streams if number specified
            if [ "$NUM_STREAMS" -gt 0 ]; then
                echo ""
                echo "Adding $NUM_STREAMS streams..."
                for i in $(seq 0 $((NUM_STREAMS-1))); do
                    curl -s -X POST http://localhost:$API_PORT/stream/add \
                      -H "Content-Type: application/json" \
                      -d "{\"id\": $i}" > /dev/null
                    echo "  ✓ Added stream $i"
                done
            fi
        else
            echo "✗ Failed to start batch container"
            docker logs "$CONTAINER_NAME"
        fi
        ;;
    stop)
        docker stop "$CONTAINER_NAME" 2>/dev/null
        docker rm "$CONTAINER_NAME" 2>/dev/null
        echo "✓ Batch inference container stopped"
        ;;
    restart)
        $0 stop && $0 start
        ;;
    status)
        docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}"
        echo ""
        curl -s http://localhost:$API_PORT/stream/status 2>/dev/null | python3 -m json.tool || echo "API not reachable"
        ;;
    logs)
        docker logs "$CONTAINER_NAME" "${@:2}"
        ;;
    add)
        STREAM_ID="$2"
        if [ -z "$STREAM_ID" ]; then
            echo "Usage: $0 add <stream_id>"
            exit 1
        fi
        curl -X POST http://localhost:$API_PORT/stream/add \
          -H "Content-Type: application/json" \
          -d "{\"id\": $STREAM_ID}"
        echo ""
        ;;
    remove)
        STREAM_ID="$2"
        if [ -z "$STREAM_ID" ]; then
            echo "Usage: $0 remove <stream_id>"
            exit 1
        fi
        curl -X POST http://localhost:$API_PORT/stream/remove \
          -H "Content-Type: application/json" \
          -d "{\"id\": $STREAM_ID}"
        echo ""
        ;;
    *)
        echo "Usage: $0 {N|build|start|stop|restart|status|logs|add|remove}"
        echo ""
        echo "Quick start:"
        echo "  $0 3               # Start batch with 3 streams (s0, s1, s2)"
        echo "  $0 16              # Start batch with 16 streams (s0-s15)"
        echo ""
        echo "Manual control:"
        echo "  $0 start           # Start batch container (no streams)"
        echo "  $0 start 4         # Start batch + add 4 streams"
        echo "  $0 add 0           # Add stream 0"
        echo "  $0 remove 0        # Remove stream 0"
        echo "  $0 status          # Show active streams"
        echo "  $0 logs --tail 20  # View logs"
        exit 1
        ;;
esac
