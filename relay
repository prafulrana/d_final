#!/bin/bash
# Manage remote relay (frps + mediamtx)

RELAY="mediamtx-relay"
ZONE="asia-south1-c"

case "$1" in
    restart)
        /home/prafulrana/google-cloud-sdk/bin/gcloud compute ssh "$RELAY" --zone="$ZONE" \
          --command="docker restart frps mediamtx && sleep 3 && docker ps --filter 'name=frps|mediamtx'"
        ;;
    status)
        /home/prafulrana/google-cloud-sdk/bin/gcloud compute ssh "$RELAY" --zone="$ZONE" \
          --command="docker ps --filter 'name=frps|mediamtx' && echo '' && docker logs mediamtx --tail 10"
        ;;
    logs)
        LINES="${2:-30}"
        FILTER="${3}"
        if [ -n "$FILTER" ]; then
            /home/prafulrana/google-cloud-sdk/bin/gcloud compute ssh "$RELAY" --zone="$ZONE" \
              --command="docker logs mediamtx --tail $LINES 2>&1 | grep -E '$FILTER'"
        else
            /home/prafulrana/google-cloud-sdk/bin/gcloud compute ssh "$RELAY" --zone="$ZONE" \
              --command="docker logs mediamtx --tail $LINES"
        fi
        ;;
    *)
        echo "Usage: $0 {restart|status|logs [lines] [filter]}"
        echo "  logs [lines] [filter] - Show MediaMTX logs (default: 30 lines)"
        echo "  Examples:"
        echo "    $0 logs              # Show last 30 lines"
        echo "    $0 logs 50           # Show last 50 lines"
        echo "    $0 logs 50 'in_s0'   # Show last 50 lines filtered by 'in_s0'"
        exit 1
        ;;
esac
